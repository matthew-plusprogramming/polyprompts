<!doctype html>
<html lang="en">
<<<<<<< HEAD
<head>
<meta charset="utf-8"/>
<title>Live Transcription</title>
<style>
  body { font-family: monospace; background: #07080f; color: #e2e4f0; padding: 40px; max-width: 700px; margin: 0 auto; }
  h1 { color: #4fffb0; margin-bottom: 24px; font-size: 24px; }
  button { font-family: monospace; font-size: 13px; padding: 9px 18px; margin: 4px; border-radius: 8px; border: none; cursor: pointer; }
  #connectBtn    { background: #1a3a2a; color: #4fffb0; border: 1px solid #4fffb044; }
  #disconnectBtn { background: #3a1a1a; color: #ff6b6b; border: 1px solid #ff6b6b44; }
  #clearBtn      { background: #1e2035; color: #888; border: 1px solid #252640; }
  button:disabled { opacity: 0.3; cursor: not-allowed; }
  #status { margin: 16px 0; padding: 10px 14px; background: #1e2035; border-radius: 8px; font-size: 12px; color: #888; }
  #status.ok  { color: #4fffb0; }
  #status.err { color: #ff6b6b; }
  .stats { display: flex; gap: 10px; margin: 12px 0; }
  .stat { background: #1e2035; border: 1px solid #252640; border-radius: 8px; padding: 10px 16px; font-size: 11px; color: #888; min-width: 100px; }
  .stat b { color: #e2e4f0; font-size: 20px; display: block; }
  .stat b.amber { color: #fbbf24; }
  #tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; min-height: 10px; }
  .tag { background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); border-radius: 100px; padding: 2px 10px; font-size: 11px; color: #fbbf24; }
  #out { min-height: 280px; padding: 16px; background: #05050c; border: 1px solid #1a1b2e; border-radius: 10px; font-size: 14px; line-height: 2.2; word-break: break-word; }
  .ph  { color: #333; font-style: italic; }
  .hi  { background: rgba(251,191,36,0.15); border: 1px solid rgba(251,191,36,0.4); border-radius: 3px; padding: 0 3px; color: #fbbf24; font-weight: bold; }
  .lv  { color: #a78bfa; }
</style>
</head>
<body>
<h1>⚡ Live Transcription</h1>

<div>
  <button id="connectBtn">Connect</button>
  <button id="disconnectBtn" disabled>Disconnect</button>
  <button id="clearBtn">Clear</button>
</div>

<div id="status">Not connected.</div>

<div class="stats">
  <div class="stat">Words<b id="sW">0</b></div>
  <div class="stat">Fillers<b class="amber" id="sF">0</b></div>
  <div class="stat">Rate<b id="sR">—</b></div>
</div>
<div id="tags"></div>
<div id="out"><span class="ph">Transcript appears here…</span></div>

<script>
const FILLERS = new Set([
  "um","uh","er","ah","like","basically","literally","actually",
  "so","right","okay","well","just","really","totally","honestly",
  "anyway","you know","i mean","kind of","sort of","kinda","sorta"
]);

let ws, stream, ctx, proc;
let words=0, fillers=0, counts={}, liveSpan=null;

const out    = document.getElementById("out");
const status = document.getElementById("status");

function ss(msg, cls) { status.textContent=msg; status.className=cls||""; }

function updateStats() {
  document.getElementById("sW").textContent = words;
  document.getElementById("sF").textContent = fillers;
  document.getElementById("sR").textContent = words ? ((fillers/words)*100).toFixed(1)+"%" : "—";
  document.getElementById("tags").innerHTML = Object.entries(counts)
    .sort((a,b)=>b[1]-a[1])
    .map(([w,c])=>`<span class="tag">${w} ×${c}</span>`).join("");
}

function renderWord(w) {
  const clean = w.toLowerCase().replace(/[.,!?']+$/,"");
  if (FILLERS.has(clean)) { counts[clean]=(counts[clean]||0)+1; fillers++; return `<span class="hi">${w}</span> `; }
  return w+" ";
}

function addFinal(wlist, raw) {
  if (!raw.trim()) return;
  liveSpan?.remove(); liveSpan=null;
  out.querySelector(".ph")?.remove();
  const s=document.createElement("span");
  s.innerHTML=wlist.map(renderWord).join("");
  out.appendChild(s);
  out.scrollTop=out.scrollHeight;
  words+=wlist.length;
  updateStats();
}

function setLive(text) {
  out.querySelector(".ph")?.remove();
  if (!liveSpan) { liveSpan=document.createElement("span"); liveSpan.className="lv"; out.appendChild(liveSpan); }
  liveSpan.textContent=text;
  out.scrollTop=out.scrollHeight;
}

document.getElementById("clearBtn").onclick = () => {
  out.innerHTML='<span class="ph">Transcript appears here…</span>';
  liveSpan=null; words=fillers=0; counts={}; updateStats();
};

async function connect() {
  document.getElementById("connectBtn").disabled=true;
  ss("Getting key…");
  try {
    const r = await fetch("/api/key", { method:"POST" });
    const j = await r.json();
    if (!r.ok || !j.key) throw new Error(j.error||"No key returned");

    const params = new URLSearchParams({
      model:"nova-2", language:"en-US", smart_format:"true",
      filler_words:"true", interim_results:"true",
      utterance_end_ms:"1000", encoding:"linear16",
      sample_rate:"16000", channels:"1",
    });

    // Use subprotocol auth — the correct Deepgram method
    ws = new WebSocket(
      `wss://api.deepgram.com/v1/listen?${params}`,
      ["token", j.key]
    );

    ws.onopen = async () => {
      ss("Getting mic…","ok");
      stream = await navigator.mediaDevices.getUserMedia({ audio:true });
      ctx    = new AudioContext({ sampleRate:16000 });
      const src = ctx.createMediaStreamSource(stream);
      proc = ctx.createScriptProcessor(4096,1,1);
      src.connect(proc); proc.connect(ctx.destination);
      proc.onaudioprocess = e => {
        if (ws.readyState!==WebSocket.OPEN) return;
        const f=e.inputBuffer.getChannelData(0), i=new Int16Array(f.length);
        for(let n=0;n<f.length;n++) i[n]=Math.max(-32768,Math.min(32767,f[n]*32768));
        ws.send(i.buffer);
      };
      document.getElementById("disconnectBtn").disabled=false;
      ss("Mic live — speak now.","ok");
    };

    ws.onmessage = e => {
      try {
        const d=JSON.parse(e.data);
        if (d.type!=="Results") return;
        const alt=d.channel?.alternatives?.[0];
        if (!alt) return;
        const wlist=alt.words?.map(w=>w.punctuated_word||w.word)||[];
        if (d.is_final) { if(alt.transcript?.trim()) addFinal(wlist,alt.transcript); }
        else            { if(alt.transcript?.trim()) setLive(alt.transcript); }
      } catch{}
    };

    ws.onclose = e => { ss("Disconnected.","err"); reset(); };
    ws.onerror = ()  => { ss("WebSocket error.","err"); reset(); };

  } catch(err) {
    ss("Error: "+err.message,"err"); console.error(err); reset();
  }
}

function disconnect() {
  proc?.disconnect(); ctx?.close(); stream?.getTracks().forEach(t=>t.stop()); ws?.close();
  proc=ctx=stream=ws=null;
  ss("Disconnected."); reset();
}

function reset() {
  document.getElementById("connectBtn").disabled=false;
  document.getElementById("disconnectBtn").disabled=true;
}

document.getElementById("connectBtn").onclick=connect;
document.getElementById("disconnectBtn").onclick=disconnect;
</script>
</body>
=======
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>polyprompts-app</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
>>>>>>> 354073af7a13f0b961ac71233fd03e846d70e3d9
</html>
